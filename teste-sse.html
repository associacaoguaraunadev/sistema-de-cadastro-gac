<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste SSE - Sistema de Cadastro GAC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .events {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .event {
            padding: 8px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
            background: white;
            border-radius: 4px;
        }
        .event.error { border-left-color: #dc3545; }
        .event.success { border-left-color: #28a745; }
        .event.warning { border-left-color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª Teste SSE - Sistema de Cadastro GAC</h1>

        <div id="status" class="status disconnected">
            ðŸ”Œ Desconectado
        </div>

        <div class="controls">
            <button id="connectBtn">Conectar SSE</button>
            <button id="disconnectBtn" disabled>Desconectar</button>
            <button id="clearBtn">Limpar Log</button>
        </div>

        <h3>ðŸ“‹ Eventos Recebidos:</h3>
        <div id="events" class="events">
            <div class="event">Aguardando conexÃ£o...</div>
        </div>
    </div>

    <script>
        let eventSource = null;
        const statusDiv = document.getElementById('status');
        const eventsDiv = document.getElementById('events');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        function addEvent(message, type = 'info') {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type}`;
            eventDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            eventsDiv.appendChild(eventDiv);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }

        function updateStatus(connected, message) {
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
            statusDiv.textContent = message;
        }

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            addEvent('ðŸ”— Tentando conectar ao SSE...', 'warning');

            // Usar token de teste ou vazio para teste bÃ¡sico
            const token = localStorage.getItem('token') || 'test-token';
            const url = `http://localhost:3001/api/eventos/sse?token=${encodeURIComponent(token)}`;

            eventSource = new EventSource(url);

            eventSource.onopen = () => {
                updateStatus(true, 'âœ… Conectado ao SSE');
                addEvent('âœ… ConexÃ£o SSE estabelecida', 'success');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            };

            eventSource.onmessage = (event) => {
                addEvent(`ðŸ“¨ Mensagem: ${event.data}`, 'info');
            };

            eventSource.onerror = (error) => {
                updateStatus(false, 'âŒ Erro na conexÃ£o SSE');
                addEvent(`âŒ Erro SSE: ${error}`, 'error');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };

            // Eventos especÃ­ficos
            eventSource.addEventListener('connected', (event) => {
                const data = JSON.parse(event.data);
                addEvent(`ðŸŽ¯ Conectado: ${JSON.stringify(data)}`, 'success');
            });

            eventSource.addEventListener('heartbeat', (event) => {
                const data = JSON.parse(event.data);
                addEvent(`ðŸ’“ Heartbeat: ${JSON.stringify(data)}`, 'info');
            });

            eventSource.addEventListener('pessoaCadastrada', (event) => {
                const data = JSON.parse(event.data);
                addEvent(`ðŸ‘¤ Pessoa cadastrada: ${data.pessoa?.nome || 'N/A'}`, 'success');
            });

            eventSource.addEventListener('pessoaAtualizada', (event) => {
                const data = JSON.parse(event.data);
                addEvent(`âœï¸ Pessoa atualizada: ${data.pessoa?.nome || 'N/A'}`, 'warning');
            });

            eventSource.addEventListener('pessoaDeletada', (event) => {
                const data = JSON.parse(event.data);
                addEvent(`ðŸ—‘ï¸ Pessoa deletada: ${data.pessoa?.nome || 'N/A'}`, 'error');
            });

            eventSource.addEventListener('keepalive', (event) => {
                addEvent('ðŸ”„ Keepalive recebido', 'info');
            });
        }

        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            updateStatus(false, 'ðŸ”Œ Desconectado');
            addEvent('ðŸ”Œ ConexÃ£o SSE fechada', 'warning');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
        }

        function clearLog() {
            eventsDiv.innerHTML = '<div class="event">Log limpo</div>';
        }

        // Event listeners
        connectBtn.addEventListener('click', connectSSE);
        disconnectBtn.addEventListener('click', disconnectSSE);
        document.getElementById('clearBtn').addEventListener('click', clearLog);

        // Auto-conectar ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                connectSSE();
            }, 1000);
        });

        // Cleanup ao fechar
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>